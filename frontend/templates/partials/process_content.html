<!-- partials/process_content.html -->
<div id="process-container" class="w-full max-w-lg mx-auto space-y-8" data-job-id="{{ job_id }}">

    <!-- Custom Styles moved to static/custom.css -->


    <header class="text-center space-y-2">
        <h2 class="text-2xl font-bold text-white">Processing Video</h2>
    </header>

    <div
        class="glass-panel rounded-3xl p-6 sm:p-8 shadow-2xl shadow-black/50 relative overflow-hidden bg-slate-900/40 backdrop-blur-xl border border-white/10">

        <!-- Background Ambient Glow -->
        <div
            class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent">
        </div>

        <!-- Progress UI -->
        <div id="sse-container" class="flex flex-col gap-8 relative z-10">
            <!-- Status Steps -->
            <div class="flex items-center justify-between text-xs font-bold text-slate-500 uppercase tracking-widest">
                <span class="text-indigo-400 drop-shadow-md">Uploaded</span>
                <span id="step-processing"
                    class="animate-pulse text-indigo-300 drop-shadow-[0_0_8px_rgba(99,102,241,0.6)]">Processing</span>
                <span id="step-complete">Complete</span>
            </div>

            <!-- Spectacular Progress Bar -->
            <div class="space-y-2">
                <div
                    class="relative h-6 bg-slate-800/80 rounded-full overflow-hidden shadow-[inset_0_2px_4px_rgba(0,0,0,0.6)] border border-white/5 ring-1 ring-white/10">

                    <!-- The Fill -->
                    <div id="progress-fill" style="width: 0%"
                        class="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 transition-all duration-500 ease-out progress-glow">

                        <!-- Inner Shimmer/Shine -->
                        <div
                            class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/40 to-transparent -translate-x-full animate-[shimmer-fast_2s_infinite_linear]">
                        </div>

                        <!-- End Cap Glow -->
                        <div class="absolute right-0 top-0 h-full w-2 bg-white/50 blur-[2px]"></div>
                    </div>
                </div>
                <!-- Percentage Check -->
                <div class="flex justify-end">
                    <span id="progress-percent" class="text-xs font-mono text-indigo-300">0%</span>
                </div>
            </div>

            <!-- Status Text Area -->
            <div class="text-center space-y-1">
                <div id="status-text"
                    class="text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 via-white to-purple-200 animate-pulse drop-shadow-sm">
                    Connecting...
                </div>
                <!-- Granular Detail (Chunks etc) -->
                <div id="status-detail" class="text-sm font-mono font-medium text-slate-400 h-5">
                    <!-- Detail populated by JS -->
                </div>
            </div>

            <!-- Result Video -->
            <div id="video-container"
                class="hidden mt-6 rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative group">
                <video id="result-video" controls class="w-full bg-black/50">
                    <source src="" type="video/mp4">
                </video>
            </div>

            <!-- Queue Info (Hidden by default) -->
            <div id="queue-container" class="hidden text-center transform transition-all">
                <div
                    class="inline-block bg-slate-800/80 rounded-lg px-6 py-3 border border-indigo-500/30 shadow-[0_0_15px_rgba(99,102,241,0.15)]">
                    <div class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1">Queue Position</div>
                    <div class="font-mono text-2xl font-bold text-white leading-none flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                        </span>
                        <span><span id="queue-pos">-</span> / <span id="queue-size">-</span></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div id="actions" class="hidden text-center mt-4">
                <a id="download-btn" href="#"
                    class="inline-flex items-center justify-center px-8 py-4 border border-indigo-500/50 text-lg font-bold rounded-xl text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-[0_0_20px_rgba(79,70,229,0.4)] hover:shadow-[0_0_30px_rgba(168,85,247,0.6)] transition-all transform hover:-translate-y-1 group">
                    <span>Download Video</span>
                    <span class="ml-2 group-hover:rotate-12 transition-transform">üöÄ</span>
                </a>
                <a href="/"
                    class="block mt-6 text-sm text-slate-400 hover:text-white transition-colors border-b border-transparent hover:border-slate-400 inline-block pb-0.5">Process
                    Another Video</a>
            </div>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="hidden text-center space-y-6 py-4">
            <div class="relative w-20 h-20 mx-auto">
                <div class="absolute inset-0 bg-red-500/20 rounded-full animate-ping"></div>
                <div
                    class="relative flex items-center justify-center w-full h-full bg-red-500/10 rounded-full border border-red-500/50 text-4xl">
                    ‚ö†Ô∏è</div>
            </div>

            <div class="space-y-2">
                <h3 class="text-xl font-bold text-white">Processing Failed</h3>
                <p id="error-msg"
                    class="text-red-300 text-sm bg-red-950/30 p-3 rounded-lg border border-red-500/20 mx-auto max-w-xs break-words">
                    Unknown error.</p>
            </div>

            <button onclick="window.location.reload()"
                class="px-6 py-2 bg-slate-700 text-white font-medium rounded-lg hover:bg-slate-600 transition-colors border border-white/5">
                Retry Connection
            </button>
            <a href="/" class="block mt-4 text-xs text-slate-500 hover:text-white uppercase tracking-wider">Return
                Home</a>
        </div>
    </div>

    <script>
        (function () {
            const container = document.getElementById('process-container');
            const jobId = "{{ job_id }}";

            console.log(`üîå INIT Process View for Job: ${jobId}`);

            // Update URL if needed
            if (!window.location.pathname.includes(jobId) && !window.location.pathname.includes("process")) {
                try {
                    window.history.pushState({}, '', `/process/${jobId}`);
                } catch (e) { console.warn("History push failed", e); }
            }

            // UI Elements
            const progressFill = container.querySelector('#progress-fill');
            const progressPercent = container.querySelector('#progress-percent');
            const statusText = container.querySelector('#status-text');
            const statusDetail = container.querySelector('#status-detail');

            const queueContainer = container.querySelector('#queue-container');
            const queuePos = container.querySelector('#queue-pos');
            const queueSize = container.querySelector('#queue-size');

            const actions = container.querySelector('#actions');
            const downloadBtn = container.querySelector('#download-btn');

            const stepProcessing = container.querySelector('#step-processing');
            const stepComplete = container.querySelector('#step-complete');

            const errorContainer = container.querySelector('#error-container');
            const sseUiContainer = container.querySelector('#sse-container');
            const errorMsg = container.querySelector('#error-msg');

            function handleProgress(e) {
                const data = e.detail;

                if (data.type === 'progress') {
                    // Update main bar
                    progressFill.style.width = `${data.progress}%`;
                    progressPercent.textContent = `${data.progress}%`;

                    // Update text
                    statusText.textContent = data.status || 'Processing...';

                    // Update Detail (New!)
                    if (data.detail) {
                        statusDetail.textContent = data.detail;
                        statusDetail.classList.remove('opacity-0');
                    } else {
                        statusDetail.textContent = '';
                    }

                    // Queue Logic
                    if (data.position && data.position !== 'Processing' && data.position !== '-') {
                        queueContainer.classList.remove('hidden');
                        queuePos.textContent = data.position;
                        queueSize.textContent = data.queue_size;
                        // While in queue, status might be generic, detail might be empty
                    } else {
                        queueContainer.classList.add('hidden');
                    }

                } else if (data.type === 'complete') {
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';

                    statusText.textContent = 'Done! üéâ';
                    statusText.textContent = 'Done! üéâ';
                    statusText.classList.remove('animate-pulse', 'bg-clip-text', 'text-transparent', 'bg-gradient-to-r', 'from-indigo-200', 'via-white', 'to-purple-200');
                    statusText.classList.add('text-green-400');
                    statusDetail.textContent = 'Your video is ready.';

                    stepProcessing.classList.remove('animate-pulse', 'text-indigo-300');
                    stepProcessing.classList.add('text-slate-500');

                    stepComplete.classList.add('text-green-400', 'font-bold', 'drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]');
                    queueContainer.classList.add('hidden');

                    if (data.video_url) {
                        const videoContainer = container.querySelector('#video-container');
                        const videoPlayer = container.querySelector('#result-video');

                        if (videoContainer && videoPlayer) {
                            videoPlayer.src = data.video_url;
                            videoContainer.classList.remove('hidden');
                            videoPlayer.load(); // Ensure it loads
                            // Try autoplay
                            videoPlayer.play().catch(e => console.log("Autoplay prevented", e));
                        }

                        downloadBtn.href = data.video_url;
                        actions.classList.remove('hidden');
                        actions.classList.add('animate-[fadeIn_1s_ease-out]');
                    }
                } else if (data.type === 'error') {
                    showError(data.error_message);
                }
            }

            function showError(msg) {
                sseUiContainer.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                errorMsg.textContent = msg;
            }

            // Listen for global events dispatched by index.html
            document.addEventListener('job-progress', handleProgress);

            // Cleanup listener check
            const originalHandle = handleProgress;
            const safeHandle = (e) => {
                if (!document.body.contains(container)) {
                    document.removeEventListener('job-progress', safeHandle);
                    return;
                }
                originalHandle(e);
            }
            document.removeEventListener('job-progress', handleProgress);
            document.addEventListener('job-progress', safeHandle);

        })();
    </script>
</div>
<!-- partials/process_content.html -->
<div id="process-container" class="w-full max-w-lg mx-auto space-y-8" data-job-id="{{ job_id }}">

    <header class="text-center space-y-2">
        <div
            class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/30 mb-2">
            <span class="text-2xl">üé∏</span>
        </div>
        <h2 class="text-2xl font-bold text-white">Processing Video</h2>
        <p class="text-slate-400 text-sm">Job ID: <span class="font-mono text-indigo-400">{{ job_id }}</span></p>
    </header>

    <div class="glass-panel rounded-3xl p-6 sm:p-8 shadow-2xl shadow-black/50">
        <!-- Progress UI -->
        <div id="sse-container" class="flex flex-col gap-6">
            <!-- Status Steps -->
            <div
                class="flex items-center justify-between text-xs font-semibold text-slate-500 uppercase tracking-wider">
                <span class="text-indigo-400">Uploaded</span>
                <span id="step-processing" class="animate-pulse text-indigo-400">Processing</span>
                <span id="step-complete">Complete</span>
            </div>

            <!-- Progress Bar -->
            <div class="relative h-4 bg-gray-800 rounded-full overflow-hidden shadow-inner border border-white/5">
                <div id="progress-fill" style="width: 0%"
                    class="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-300 ease-out">
                    <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="bg-gray-800/50 rounded-lg p-3 border border-white/5">
                    <div class="text-xs text-slate-400 mb-1">Queue Position</div>
                    <div class="font-mono text-xl font-bold text-white leading-none">
                        <span id="queue-pos">-</span>/<span id="queue-size">-</span>
                    </div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-3 border border-white/5">
                    <div class="text-xs text-slate-400 mb-1">Status</div>
                    <div id="status-text" class="font-md text-white leading-none truncate px-1">Connecting...</div>
                </div>
            </div>

            <!-- Actions -->
            <div id="actions" class="hidden text-center mt-4">
                <a id="download-btn" href="#"
                    class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10 transition-all shadow-lg shadow-indigo-500/30">
                    Download Video üé•
                </a>
                <a href="/" class="block mt-4 text-sm text-slate-400 hover:text-white transition-colors">Process
                    Another</a>
            </div>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="hidden text-center space-y-4">
            <div class="text-red-500 text-5xl">‚ö†Ô∏è</div>
            <h3 class="text-xl font-bold text-white">Something went wrong</h3>
            <p id="error-msg" class="text-slate-400 text-sm">Unknown error occurred.</p>
            <button onclick="window.location.reload()"
                class="px-4 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors">
                Retry Connection
            </button>
            <a href="/" class="block mt-4 text-sm text-slate-400 hover:text-white">Go Home</a>
        </div>
    </div>

    <script>
        (function () {
            const container = document.getElementById('process-container');
            const jobId = "{{ job_id }}";

            console.log(`üîå INIT Process View for Job: ${jobId}`);

            // Update URL only if not already match
            if (!window.location.pathname.includes(jobId) && !window.location.pathname.includes("process")) {
                try {
                    window.history.pushState({}, '', `/process/${jobId}`);
                } catch (e) { console.warn("History push failed", e); }
            }

            // UI Elements
            const progressFill = container.querySelector('#progress-fill');
            const queuePos = container.querySelector('#queue-pos');
            const queueSize = container.querySelector('#queue-size');
            const statusText = container.querySelector('#status-text');
            const actions = container.querySelector('#actions');
            const downloadBtn = container.querySelector('#download-btn');
            const stepProcessing = container.querySelector('#step-processing');
            const stepComplete = container.querySelector('#step-complete');
            const errorContainer = container.querySelector('#error-container');
            const sseUiContainer = container.querySelector('#sse-container');
            const errorMsg = container.querySelector('#error-msg');

            function handleProgress(e) {
                const data = e.detail;
                // console.log('Job Data:', data); 

                if (data.type === 'progress') {
                    progressFill.style.width = `${data.progress}%`;
                    statusText.textContent = data.status || 'Processing...';

                    if (data.position && data.position !== 'Processing') {
                        queuePos.textContent = data.position;
                        queueSize.textContent = data.queue_size;
                    }
                } else if (data.type === 'complete') {
                    progressFill.style.width = '100%';
                    statusText.textContent = 'Done!';
                    stepProcessing.classList.remove('animate-pulse');
                    stepComplete.classList.add('text-green-400', 'font-bold');

                    if (data.video_url) {
                        downloadBtn.href = data.video_url;
                        actions.classList.remove('hidden');
                    }
                    // We don't close the source because it's global
                } else if (data.type === 'error') {
                    showError(data.error_message);
                }
            }

            function showError(msg) {
                sseUiContainer.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                errorMsg.textContent = msg;
            }

            // Listen for global events dispatched by index.html
            document.addEventListener('job-progress', handleProgress);

            // Cleanup listener if this element is removed (MutationObserver or similar needed for true exact cleanup, 
            // but for this app replacing the innerHTML is the main way it changes)
            // For now, simpler: we check if container exists in the handler? 
            // Better: Since the page reload clears everything, and HTMX swap replaces it...
            // JS closures might persist attached to document. 
            // Let's implement a self-check.

            // Overwriting the handler to perform a check
            const originalHandle = handleProgress;
            const safeHandle = (e) => {
                if (!document.body.contains(container)) {
                    document.removeEventListener('job-progress', safeHandle);
                    return;
                }
                originalHandle(e);
            }
            // Remove previous if any (hard to do with anonymous, so we rely on the check)
            document.removeEventListener('job-progress', handleProgress); // Won't work for prev instances
            document.addEventListener('job-progress', safeHandle);

        })();
    </script>
</div>
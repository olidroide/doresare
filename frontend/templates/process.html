<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    {% include 'partials/head.html' %}
</head>

<body class="bg-slate-950 text-slate-200 min-h-full font-sans selection:bg-indigo-500/30 selection:text-indigo-200">

    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div
            class="absolute top-0 left-1/4 w-96 h-96 bg-indigo-600/20 rounded-full blur-3xl mix-blend-screen animate-pulse-slow">
        </div>
        <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-600/10 rounded-full blur-3xl mix-blend-screen">
        </div>
    </div>

    <main class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-lg mx-auto space-y-8">

            <header class="text-center space-y-2">
                <a href="/" class="inline-block transform hover:scale-105 transition-transform">
                    <div
                        class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/30 mb-2">
                        <span class="text-2xl">üé∏</span>
                    </div>
                </a>
                <h2 class="text-2xl font-bold text-white">Processing Video</h2>
                <p class="text-slate-400 text-sm">Job ID: <span class="font-mono text-indigo-400">{{ job_id }}</span>
                </p>
            </header>

            <div class="glass-panel rounded-3xl p-6 sm:p-8 shadow-2xl shadow-black/50">

                <!-- Progress Container -->
                <div id="sse-container" class="flex flex-col gap-6">
                    <!-- Status Steps -->
                    <div
                        class="flex items-center justify-between text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        <span class="text-indigo-400">Uploaded</span>
                        <span id="step-processing" class="animate-pulse text-indigo-400">Processing</span>
                        <span id="step-complete">Complete</span>
                    </div>

                    <!-- Progress Bar -->
                    <div
                        class="relative h-4 bg-gray-800 rounded-full overflow-hidden shadow-inner border border-white/5">
                        <div id="progress-fill" style="width: 0%"
                            class="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-300 ease-out">
                            <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-xs text-slate-400 mb-1">Queue Position</div>
                            <div class="font-mono text-xl font-bold text-white leading-none">
                                <span id="queue-pos">-</span>/<span id="queue-size">-</span>
                            </div>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-xs text-slate-400 mb-1">Status</div>
                            <div id="status-text" class="font-md text-white leading-none truncate px-1">Connecting...
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div id="actions" class="hidden text-center mt-4">
                        <a id="download-btn" href="#"
                            class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10 transition-all shadow-lg shadow-indigo-500/30">
                            Download Video üé•
                        </a>
                        <a href="/" class="block mt-4 text-sm text-slate-400 hover:text-white transition-colors">Process
                            Another</a>
                    </div>
                </div>

                <!-- Error Container -->
                <div id="error-container" class="hidden text-center space-y-4">
                    <div class="text-red-500 text-5xl">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-white">Something went wrong</h3>
                    <p id="error-msg" class="text-slate-400 text-sm">Unknown error occurred.</p>
                    <button onclick="window.location.reload()"
                        class="px-4 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors">
                        Retry Connection
                    </button>
                    <a href="/" class="block mt-4 text-sm text-slate-400 hover:text-white">Go Home</a>
                </div>

            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const jobId = "{{ job_id }}";
            const sseUrl = `/sse/${jobId}`;

            console.log(`üîå Connecting to SSE: ${sseUrl}`);

            // Push URL to history so refresh works (Persistent UX)
            // Only push if we are not already there (checking pathname)
            if (!window.location.pathname.includes(jobId)) {
                window.history.pushState({}, '', `/process/${jobId}`);
            }

            const evtSource = new EventSource(sseUrl);

            const progressFill = document.getElementById('progress-fill');
            const queuePos = document.getElementById('queue-pos');
            const queueSize = document.getElementById('queue-size');
            const statusText = document.getElementById('status-text');
            const actions = document.getElementById('actions');
            const downloadBtn = document.getElementById('download-btn');
            const stepProcessing = document.getElementById('step-processing');
            const stepComplete = document.getElementById('step-complete');

            // Robust Reconnection Logic is built-in to EventSource, 
            // but we add a listener for error to show UI feedback if it fails hard.

            evtSource.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log('SSE Data:', data);

                if (data.type === 'progress') {
                    // Update Progress
                    progressFill.style.width = `${data.progress}%`;
                    statusText.textContent = data.status || 'Processing...';

                    if (data.position && data.position !== 'Processing') {
                        queuePos.textContent = data.position;
                        queueSize.textContent = data.queue_size;
                        statusText.textContent = `Queued (${data.position}/${data.queue_size})`;
                    } else {
                        queuePos.textContent = '-';
                        queueSize.textContent = '-';
                    }

                } else if (data.type === 'complete') {
                    // Complete
                    progressFill.style.width = '100%';
                    statusText.textContent = 'Done!';
                    stepProcessing.classList.remove('animate-pulse');
                    stepComplete.classList.add('text-green-400', 'font-bold');

                    if (data.video_url) {
                        downloadBtn.href = data.video_url;
                        actions.classList.remove('hidden');
                        actions.classList.add('animate-fade-in-up'); // Custom animation or standard
                    }

                    evtSource.close();

                } else if (data.type === 'error') {
                    showError(data.error_message);
                    evtSource.close();
                }
            };

            evtSource.onerror = function (e) {
                console.log("SSE Error (might be connecting...)", e);
                // Don't show error immediately as browser auto-reconnects.
                // If it stays dead for long, user can click retry button which reloads page.
            };

            function showError(msg) {
                document.getElementById('sse-container').classList.add('hidden');
                document.getElementById('error-container').classList.remove('hidden');
                document.getElementById('error-msg').textContent = msg;
            }
        });
    </script>
</body>

</html>